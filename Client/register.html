<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>register page</title>
        <link rel="stylesheet" href="css/global.css">
        <link rel="stylesheet" href="css/register.css">
        <link rel="stylesheet" href="css/cookie_consent.css">
        <script type="text/javascript" src="js/register.js"></script>
        <script type="text/javascript" src="js/cookie_consent.js"></script>
        <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
        <script src="js/amazon-congito-auth.min.js"></script>
        <script src="js/amazon-cognito-identity.min.js"></script>
        <script src="js/config.js"></script>
        <script>
            function register() {

                let email = document.getElementById('email_textbox').value;
                let username = document.getElementById('username_textbox').value;
                let otp_username = document.getElementById('otp_username_textbox');
                let password = document.getElementById('password_textbox').value;
                let passwordConfirm = document.getElementById('re-enter_password_textbox').value;

                if (email === '' || username === '' || password === '' || passwordConfirm === '') {
                    alert('Please ensure all fields are filled');
                    return;
                }

                otp_username_textbox.value = username;
                if (password !== passwordConfirm) {
                    alert('Passwords do not match');
                    return;
                }

                let userPoolId = _config.cognito.UserPoolId;
                let clientId = _config.cognito.ClientId;

                var userPool = new AmazonCognitoIdentity.CognitoUserPool({UserPoolId: userPoolId, ClientId: clientId});

                let attributeList = [];

                let attributeEmail = new AmazonCognitoIdentity.CognitoUserAttribute({Name : 'email', Value : email});

                attributeList.push(attributeEmail);

                userPool.signUp(username, password, attributeList, null, function (err, result) {
                    if (err) {
                        if (err.name === 'UsernameExistsException') {
                            alert('User already exists. Use existing OTP or send a new OTP');
                            switch_to_OTP();
                            return;
                        }
                        alert(err.message);
                        return;
                    }
                    cognitoUser = result.user;
                    console.log('username is ' + cognitoUser.getUsername());

                    setCookie('currentUser', cognitoUser);
                    //add some UI confirmation

                    switch_to_OTP();
                    
                });
            }

            function confirmSignUp(){

                let username = document.getElementById('otp_username_textbox').value;
                let otp_code = document.getElementById('otp_code').value;

                if (username === '' || otp_code === '') {
                    document.getElementById('otp_error_message').value = 'Please input username and OTP';
                    document.getElementById('otp_error_message').style.display = 'block';
                    return;
                }
                poolData = {
                    UserPoolId : _config.cognito.UserPoolId,
                    ClientId : _config.cognito.ClientId
                };

                var userPool = new AmazonCognitoIdentity.CognitoUserPool (poolData);

                try{
                    cognitoUser = new AmazonCognitoIdentity.CognitoUser({Username: username, Pool: userPool});

                    cognitoUser.confirmRegistration(otp_code, true, function (err, result) {

                        if (err) {
                            alert(err.message);
                            return;
                        }
                        console.log(result);
                        });
                } catch {
                    alert('User not found');
                }
            }

            function resendOTP(){

                let username = document.getElementById('otp_username_textbox').value;

                if (username === '') {
                    alert('Input Username');
                    return;
                }

                var userPool = new AmazonCognitoIdentity.CognitoUserPool ({UserPoolId : _config.cognito.UserPoolId, ClientId : _config.cognito.ClientId});
                try{
                    cognitoUser = new AmazonCognitoIdentity.CognitoUser({Username: username, Pool: userPool});

                    cognitoUser.resendConfirmationCode(function(err, result) {
                        alert('OTP Sent. Check your inbox or junk folder');
                    });
                } catch {
                    alert('User not found');
                }
            }
        </script>
        
    </head>
    </head>
    <body onload=" () => {
        load_cookie_consent_overlay();
        if (getCookie('email') !== null) {
            window.location.href = '/home.html';
        }
    }">
        <article>
            <section id="register_page" class="section_overlay">
                <section class="section_content"><h1>SIGN UP</h1>
                    <form id="register_form" class="auth_form">
                        <label id="heading_subtext">create account</label>
                        <br>
                        <input type="text" placeholder="email" id="email_textbox">
                        <br>
                        <input type="text" placeholder="username" id="username_textbox">
                        <br>
                        <input type="password" placeholder="password" id="password_textbox">
                        <br>
                        <input type="password" placeholder="re-enter password" id="re-enter_password_textbox">
                        <br>
                        <br>
                        <button class="form_button" onclick="register()" type="button">submit</button>
                        <br>
                        <button class="form_button" onclick="switch_to_OTP()" type="button">I already have an OTP</button>
                        <br>
                        <button class="form_button" onclick="window.location.href = '/login.html';" type="button">Back to sign In</button>
                    </form>
                    <section id="OTP_section" style="display:none">
                        <label id="OTP_subtext">An OTP has been sent to your email. Please enter it here</label>
                        <br>
                        <input type="text" placeholder="username" id="otp_username_textbox">
                        <br>
                        <input id="otp_code" oninput="{
                            if (this.value.length > this.maxLength) {
                                this.value = this.value.slice(0, this.maxLength);
                            }
                        }"type="number" maxlength="6" />
                        <br>
                        <button onclick="confirmSignUp()" type="button">Confirm OTP</button>
                        <br>
                        <button onclick="resendOTP()" type="button">Resend OTP</button>
                        <br>
                        <button class="form_button" onclick="window.location.href = '/login.html';" type="button">Back to sign In</button>
                    </section>
                    <br>
                </section>
                <aside id="cookie_overlay" class="cookie_overlay">
                    <section class="cookie_content">
                        <h3>Cookie Consent</h3>
                        <p>Our site uses cookie to store browser information required for navigating pages and login functionality.</p>
                        <p>By continuing to use this website, you consent to the use of cookies.</p>
                        <button onclick="close_cookie_consent()">Confirm and close</button>
                    </section>
                </aside>
            </section>
        </article>
    </body>
</html>